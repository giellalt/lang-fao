#!/bin/bash
# @configure_input@

# This is a shell script that will loop over the *.yaml files found in this dir
# and run them through the Apertium Quality morph-test.py tool.

###### Variables: #######
analyserfile=${srcdir}/../../../src/analyser.gt
generatorfile=${srcdir}/../../../src/generator.gt

###### Start testing: #######
transducer_found=0

# Loop over the transducer types first - we test both hfst and xfst if found:
for f in .xfst .hfst; do
	if [ $f == ".xfst" ]; then
		lookuptool="@LOOKUP@"
		section="xerox"
	else
		lookuptool="@HFST_LOOKUP@"
		section="hfst"
	fi
	if [ -f "$generatorfile$f" ]; then
		let "transducer_found += 1"
		if [ ! -n "$(find ${srcdir} -name '*.yaml')" ]; then
			echo
			echo "*** Warning: No YAML data files found. Skipping test."
			echo
			exit 77
		fi
		
		# Loop over the available yaml files, and run the tests:
		for file in ${srcdir}/*.yaml; do
			(( i += 1 ))
			echo
			echo "$section subtest $i: Testing $file using $analyserfile$f"
			echo
			@PYTHON@ $GTCORE/scripts/morph-test.py \
				-c -C -i \
				-S $section \
				--app $lookuptool \
				--gen $generatorfile$f \
				--morph $analyserfile$f \
				$file
		done
	fi
done

# Fail if no transducer were found:
if [ $transducer_found -eq 0 ]; then
    echo No transducer found
    exit 1
fi
